@{
    ViewData["Title"] = "E-Library Dashboard";
}

<h1>E-Library Dashboard</h1>

<div>
    <h2>Users</h2>
    <h3>Add Dummy User</h3>
    <button onclick="addDummyUser()">Add Dummy User</button>
    <ul id="userList"></ul>

    <h2>Books</h2>
    <div id="bookList"></div>
    <div style="margin-top: 20px;">
        <button onclick="changePage(-1)">Previous</button>
        <span id="pageInfo"></span>
        <button onclick="changePage(1)">Next</button>
    </div>

    <h2>Orders</h2>
    <ul id="orderList"></ul>

    <h2>Reviews</h2>
    <ul id="reviewList"></ul>
</div>

@section Scripts {
    <script>
        let currentPage = 1;
        const pageSize = 5;

        async function loadData(endpoint, listId, processor) {
            try {
                const response = await fetch(`/api/home/${endpoint}`);
                const data = await response.json();
                const list = document.getElementById(listId);
                list.innerHTML = "";

                (processor || defaultProcessor)(data, list);
            } catch (error) {
                console.error(`Error loading ${endpoint}:`, error);
            }
        }

        function defaultProcessor(data, list) {
            data.forEach(item => {
                const li = document.createElement("li");
                li.textContent = JSON.stringify(item);
                list.appendChild(li);
            });
        }

        async function loadBooks() {
            const response = await fetch(`/api/home/books?page=${currentPage}&pageSize=${pageSize}`);
            const data = await response.json();

            const list = document.getElementById("bookList");
            list.innerHTML = "";

            data.books.forEach(book => {
                const div = document.createElement("div");
                div.style.border = "1px solid #ccc";
                div.style.padding = "10px";
                div.style.marginBottom = "10px";
                div.innerHTML = `
                    <h3>${book.title}</h3>
                    <p><strong>Author:</strong> ${book.author || "N/A"}</p>
                    <p><strong>Description:</strong> ${book.description || "No description"}</p>
                    <p><strong>Price:</strong> $${book.price}</p>
                    <p><strong>Stock:</strong> ${book.stock}</p>
                `;
                list.appendChild(div);
            });

            document.getElementById("pageInfo").innerText = `Page ${data.page}`;
        }

        function changePage(offset) {
            currentPage += offset;
            if (currentPage < 1) currentPage = 1;
            loadBooks();
        }

        // Custom Order Renderer
        function renderOrders(data, list) {
            data.forEach(order => {
                const li = document.createElement("li");
                li.innerHTML = `
                    <strong>Order ID:</strong> ${order.order_Id}<br>
                    <strong>User ID:</strong> ${order.user_Id}<br>
                    <strong>Date:</strong> ${order.orderDate}<br>
                    <strong>Status:</strong> ${order.status}<br>
                    <strong>Total:</strong> $${order.totalAmount}<br>
                    <strong>Items:</strong><ul>
                        ${order.items.map(item => `
                            <li>Book ID: ${item.book_Id}, Qty: ${item.quantity}, Price: $${item.unitPrice}</li>
                        `).join("")}
                    </ul>
                `;
                list.appendChild(li);
            });
        }

        // Load all data
        loadData("", "userList");
        loadBooks();
        loadData("orders", "orderList", renderOrders);
        loadData("reviews", "reviewList");

              async function addDummyUser() {
            const response = await fetch('/api/home/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: 'testuser' + Date.now(),
                    password: 'test123'
                })
            });

            const result = await response.text();
            alert(result);
            loadData("", "userList");
        }
    </script>
}
